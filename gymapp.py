import streamlit as st
import pandas as pd

# 1. é¡µé¢åŸºæœ¬è®¾ç½®
st.set_page_config(page_title="å¥èº«åŠ©æ‰‹", page_icon="ğŸ’ª", layout="wide")

# 2. è®¡ç®— BMR (åŸºç¡€ä»£è°¢)
def get_bmr(gender, w, h, age):
    if gender == 'ç”·':
        return (10 * w) + (6.25 * h) - (5 * age) + 5
    else:
        return (10 * w) + (6.25 * h) - (5 * age) - 161

# 3. è®¡ç®— TDEE (æ€»æ¶ˆè€—)
def get_tdee(bmr, act):
    # ç³»æ•°æ˜ å°„è¡¨
    maps = {
        "ä¹…å": 1.2,
        "è½»åº¦": 1.375,
        "ä¸­åº¦": 1.55,
        "é«˜åº¦": 1.725,
        "æåº¦": 1.9
    }
    return bmr * maps[act]

# 4. ç”Ÿæˆè®­ç»ƒè¡¨ (é˜²æ­¢æ–­è¡Œï¼Œæ–‡å­—å·²ç²¾ç®€)
def get_plan(goal):
    if goal == "å‡è„‚":
        # å‡è„‚æ–¹æ¡ˆ
        d = [
            ["çƒ­èº«", "å¼€åˆè·³", "2ç»„", "30ç§’"],
            ["åŠ›é‡", "å¾’æ‰‹æ·±è¹²", "4ç»„", "20æ¬¡"],
            ["åŠ›é‡", "è·ªå§¿ä¿¯å§æ’‘", "4ç»„", "åŠ›ç«­"],
            ["åŠ›é‡", "å“‘é“ƒåˆ’èˆ¹", "4ç»„", "15æ¬¡"],
            ["æ ¸å¿ƒ", "å¹³æ¿æ”¯æ’‘", "3ç»„", "45ç§’"],
            ["æœ‰æ°§", "çˆ¬å¡å¿«èµ°", "1æ¬¡", "30åˆ†"]
        ]
        focus = "å…¨èº«å¾ªç¯+æœ‰æ°§"
    elif goal == "å¢è‚Œ":
        # å¢è‚Œæ–¹æ¡ˆ
        d = [
            ["çƒ­èº«", "è‚©è¢–æ¿€æ´»", "2ç»„", "15æ¬¡"],
            ["èƒ¸éƒ¨", "å“‘é“ƒå§æ¨", "4ç»„", "10æ¬¡"],
            ["èƒŒéƒ¨", "é«˜ä½ä¸‹æ‹‰", "4ç»„", "12æ¬¡"],
            ["è…¿éƒ¨", "è´Ÿé‡æ·±è¹²", "4ç»„", "10æ¬¡"],
            ["è‚©éƒ¨", "ä¾§å¹³ä¸¾", "3ç»„", "15æ¬¡"],
            ["è…¹è‚Œ", "å·è…¹", "3ç»„", "20æ¬¡"]
        ]
        focus = "å¤§é‡é‡åˆ†åŒ–"
    else:
        # ç»´æŒæ–¹æ¡ˆ
        d = [
            ["çƒ­èº«", "åŠ¨æ€æ‹‰ä¼¸", "1ç»„", "5åˆ†"],
            ["è‡€è…¿", "è‡€æ¡¥", "3ç»„", "15æ¬¡"],
            ["è…¿éƒ¨", "ç®­æ­¥è¹²", "3ç»„", "12æ¬¡"],
            ["ä¸Šè‚¢", "ä¿¯å§æ’‘", "3ç»„", "15æ¬¡"],
            ["æœ‰æ°§", "æ…¢è·‘", "1æ¬¡", "20åˆ†"],
            ["æ”¾æ¾", "æ³¡æ²«è½´", "1æ¬¡", "10åˆ†"]
        ]
        focus = "ä½“æ€æ”¹å–„"
    
    return focus, pd.DataFrame(d, columns=["éƒ¨ä½", "åŠ¨ä½œ", "ç»„æ•°", "æ¬¡æ•°/æ—¶é•¿"])

# 5. ç•Œé¢ UI
st.title("ğŸ’ª æç®€å¥èº«è®¡åˆ’")

with st.sidebar:
    st.header("1.è¾“å…¥æ•°æ®")
    sex = st.radio("æ€§åˆ«", ["ç”·", "å¥³"], horizontal=True)
    age = st.number_input("å¹´é¾„", 18, 80, 25)
    h = st.number_input("èº«é«˜(cm)", 100, 250, 165)
    w = st.number_input("ä½“é‡(kg)", 30.0, 200.0, 55.0)
    
    st.markdown("---")
    goal = st.selectbox("ç›®æ ‡", ["å‡è„‚", "å¢è‚Œ", "ç»´æŒ"])
    act = st.selectbox("æ´»åŠ¨é‡", ["ä¹…å", "è½»åº¦", "ä¸­åº¦", "é«˜åº¦", "æåº¦"])
    
    if st.button("ğŸš€ ç”Ÿæˆè®¡åˆ’", type="primary"):
        st.session_state['run'] = True

# 6. ç»“æœæ˜¾ç¤º
if st.session_state.get('run'):
    # è®¡ç®—
    bmr = get_bmr(sex, w, h, age)
    tdee = get_tdee(bmr, act)
    
    # è°ƒæ•´çƒ­é‡
    if goal == "å‡è„‚": target = tdee - 500
    elif goal == "å¢è‚Œ": target = tdee + 300
    else: target = tdee
    
    st.subheader("ğŸ“Š ç»“æœåˆ†æ")
    c1, c2, c3 = st.columns(3)
    c1.metric("åŸºç¡€ä»£è°¢", f"{int(bmr)}")
    c2.metric("æ—¥å¸¸æ¶ˆè€—", f"{int(tdee)}")
    c3.metric("ğŸ¯ ç›®æ ‡çƒ­é‡", f"{int(target)} kcal")
    
    st.markdown("---")
    
    focus, df = get_plan(goal)
    st.success(
